<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" dir="rtl" lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>استمارة التاريخ الطبي</title>
    <!-- jQuery UI CSS for datepicker -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.css" />
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            line-height: 1.6;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }

        h1 {
            color: #333;
            text-align: center;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        input[type="text"],
        input[type="email"],
        input[type="tel"],
        select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }

        .section {
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid #eee;
        }

        .signature-container {
            border: 1px solid #ddd;
            margin-top: 10px;
            max-width: 500px;
        }

        #signature-pad {
            width: 100%;
            height: 120px;
            border-bottom: 1px solid #ddd;
        }

        .buttons {
            margin-top: 20px;
            text-align: center;
        }

        button {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin: 0 5px;
        }

        button[type="submit"],
        button.next-button {
            background-color: #4CAF50;
            color: white;
        }

        button.prev-button {
            background-color: #607D8B;
            color: white;
        }

        button#reset-button {
            background-color: #f44336;
            color: white;
        }

        button#reset-form-button {
            background-color: #ff9800;
            color: white;
        }

        .error-message {
            color: #f44336;
            background-color: #ffebee;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 15px;
        }

        /* Datepicker styling */
        .ui-datepicker {
            font-size: 14px;
        }

        .hasDatepicker {
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>');
            background-repeat: no-repeat;
            background-position: 8px center;
            background-size: 16px;
            padding-left: 30px; /* Make room for the calendar icon */
        }

        /* Step indicator styles */
        .step-indicator {
            display: flex;
            justify-content: space-between;
            margin-bottom: 30px;
            position: relative;
        }

        .step-indicator::before {
            content: '';
            position: absolute;
            top: 15px;
            left: 0;
            right: 0;
            height: 2px;
            background: #ddd;
            z-index: 1;
        }

        .step {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background-color: #ddd;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: #fff;
            position: relative;
            z-index: 2;
        }

        .step.active {
            background-color: #4CAF50;
        }

        .step.completed {
            background-color: #4CAF50;
        }

        .step-content {
            display: none;
        }

        .step-content.active {
            display: block;
        }

        /* Guardian section styles */
        .guardian-section {
            display: none;
            background-color: #f9f9f9;
            padding: 20px;
            border-radius: 4px;
            margin-top: 20px;
            border-right: 4px solid #4CAF50;
        }

        .guardian-section.visible {
            display: block;
        }

        .guardian-section h3 {
            color: #4CAF50;
            margin-top: 0;
            margin-bottom: 15px;
        }

        .info-box {
            background-color: #e3f2fd;
            border-right: 4px solid #2196F3;
            padding: 12px;
            margin-bottom: 15px;
            border-radius: 4px;
        }

        .info-box p {
            margin: 0;
            font-size: 14px;
            color: #1976d2;
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.0.0/dist/signature_pad.umd.min.js"></script>
    <!-- jQuery and jQuery UI for datepicker -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>
</head>
<body>
<div class="container">
    <h1>استمارة التاريخ الطبي</h1>

    <!-- Error message display -->
    <div class="error-message" th:if="${errorMessage != null}" th:text="${errorMessage}"></div>

    <!-- Step Indicator -->
    <div class="step-indicator">
        <div class="step active" data-step="1">1</div>
        <div class="step" data-step="2">2</div>
        <div class="step" data-step="3">3</div>
        <div class="step" data-step="4">4</div>
    </div>

    <form id="patient-form" th:action="@{/submit-anamnesebogen}" th:object="${patientForm}" method="post">
        <!-- Include the language parameter -->
        <input type="hidden" name="lang" value="ar" />

        <!-- Step 1: Personal Data -->
        <div id="step-1" class="step-content active">
            <div class="section">
                <h2>المعلومات الشخصية</h2>
                <div class="form-group">
                    <label for="firstName">الاسم الأول</label>
                    <input type="text" id="firstName" th:field="*{firstName}" required>
                </div>
                <div class="form-group">
                    <label for="lastName">اسم العائلة</label>
                    <input type="text" id="lastName" th:field="*{lastName}" required>
                </div>
                <div class="form-group">
                    <label for="birthDate">تاريخ الميلاد</label>
                    <input type="text" id="birthDate" th:field="*{birthDate}" class="datepicker" placeholder="DD.MM.YYYY" required>
                </div>
                <div class="form-group">
                    <label for="gender">الجنس</label>
                    <select id="gender" th:field="*{gender}" required>
                        <option value="">الرجاء الاختيار</option>
                        <option value="male">ذكر</option>
                        <option value="female">أنثى</option>
                        <option value="diverse">آخر</option>
                    </select>
                </div>
            </div>
            <div class="buttons">
                <button type="button" class="next-button" data-step="1">التالي</button>
            </div>
        </div>

        <!-- Step 2: Address -->
        <div id="step-2" class="step-content">
            <div class="section">
                <h2>العنوان</h2>
                <div class="form-group">
                    <label for="street">الشارع والرقم</label>
                    <input type="text" id="street" th:field="*{street}">
                </div>
                <div class="form-group">
                    <label for="zipCode">الرمز البريدي</label>
                    <input type="text" id="zipCode" th:field="*{zipCode}">
                </div>
                <div class="form-group">
                    <label for="city">المدينة</label>
                    <input type="text" id="city" th:field="*{city}">
                </div>
            </div>
            <div class="buttons">
                <button type="button" class="prev-button" data-step="2">السابق</button>
                <button type="button" class="next-button" data-step="2">التالي</button>
            </div>
        </div>

        <!-- Step 3: Contact -->
        <div id="step-3" class="step-content">
            <div class="section">
                <h2>معلومات الاتصال</h2>
                <div class="form-group">
                    <label for="mobileNumber">رقم الهاتف المحمول</label>
                    <input type="tel" id="mobileNumber" th:field="*{mobileNumber}">
                </div>
                <div class="form-group">
                    <label for="phoneNumber">رقم الهاتف</label>
                    <input type="tel" id="phoneNumber" th:field="*{phoneNumber}">
                </div>
                <div class="form-group">
                    <label for="emailAddress">البريد الإلكتروني</label>
                    <input type="email" id="emailAddress" th:field="*{emailAddress}">
                </div>
            </div>

            <!-- Insurance Section -->
            <div class="section" id="insurance-section" style="margin-top: 30px;">
                <h2>معلومات التأمين</h2>

                <!-- Hidden field for insurance type (set automatically based on age) -->
                <input type="hidden" id="insuranceType" name="insuranceType" value="SELF_INSURED">

                <div class="info-box" id="minor-insurance-info" style="display: none;">
                    <p><strong>ملاحظة:</strong> المرضى القصر يتم تغطيتهم تلقائياً بموجب التأمين العائلي. يرجى تقديم معلومات حامل البوليصة الأساسي.</p>
                </div>
            </div>

            <!-- Guardian Section (shown only for minors under 18) -->
            <div id="guardian-section" class="guardian-section">
                <div class="info-box">
                    <p><strong>ملاحظة:</strong> نظراً لأن المريض قاصر (أقل من 18 سنة)، يجب تقديم معلومات الوصي القانوني.</p>
                </div>

                <h3>معلومات الوصي القانوني</h3>

                <div class="form-group">
                    <label for="guardian.relationshipType">العلاقة *</label>
                    <select id="guardian.relationshipType" th:field="*{guardian.relationshipType}" class="guardian-required">
                        <option value="">الرجاء الاختيار</option>
                        <option value="MOTHER">الأم</option>
                        <option value="FATHER">الأب</option>
                        <option value="LEGAL_GUARDIAN">الوصي القانوني</option>
                        <option value="GRANDPARENT">الجد/الجدة</option>
                        <option value="OTHER">آخر</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="guardian.firstName">الاسم الأول *</label>
                    <input type="text" id="guardian.firstName" th:field="*{guardian.firstName}" class="guardian-required">
                </div>

                <div class="form-group">
                    <label for="guardian.lastName">اسم العائلة *</label>
                    <input type="text" id="guardian.lastName" th:field="*{guardian.lastName}" class="guardian-required">
                </div>

                <div class="form-group">
                    <label for="guardian.birthDate">تاريخ الميلاد</label>
                    <input type="text" id="guardian.birthDate" th:field="*{guardian.birthDate}" class="datepicker" placeholder="DD.MM.YYYY">
                </div>

                <div class="form-group">
                    <label for="guardian.mobileNumber">رقم الهاتف المحمول *</label>
                    <input type="tel" id="guardian.mobileNumber" th:field="*{guardian.mobileNumber}" class="guardian-required">
                </div>

                <div class="form-group">
                    <label for="guardian.phoneNumber">رقم الهاتف</label>
                    <input type="tel" id="guardian.phoneNumber" th:field="*{guardian.phoneNumber}">
                </div>

                <div class="form-group">
                    <label for="guardian.emailAddress">البريد الإلكتروني</label>
                    <input type="email" id="guardian.emailAddress" th:field="*{guardian.emailAddress}">
                </div>

                <div class="form-group">
                    <label for="guardian.street">الشارع والرقم</label>
                    <input type="text" id="guardian.street" th:field="*{guardian.street}">
                </div>

                <div class="form-group">
                    <label for="guardian.zipCode">الرمز البريدي</label>
                    <input type="text" id="guardian.zipCode" th:field="*{guardian.zipCode}">
                </div>

                <div class="form-group">
                    <label for="guardian.city">المدينة</label>
                    <input type="text" id="guardian.city" th:field="*{guardian.city}">
                </div>
            </div>

            <!-- Policyholder Section (for family-insured patients, shown for all minors) -->
            <div id="policyholder-section" class="guardian-section" style="border-right-color: #FF9800;">
                <h3>حامل البوليصة الأساسي (التأمين العائلي)</h3>

                <div class="form-group">
                    <label>
                        <input type="checkbox" id="sameAsGuardian">
                        حامل البوليصة هو الوصي القانوني
                    </label>
                </div>

                <div class="form-group">
                    <label for="policyholder.firstName">الاسم الأول *</label>
                    <input type="text" id="policyholder.firstName" th:field="*{policyholder.firstName}" class="policyholder-required">
                </div>

                <div class="form-group">
                    <label for="policyholder.lastName">اسم العائلة *</label>
                    <input type="text" id="policyholder.lastName" th:field="*{policyholder.lastName}" class="policyholder-required">
                </div>

                <div class="form-group">
                    <label for="policyholder.birthDate">تاريخ الميلاد</label>
                    <input type="text" id="policyholder.birthDate" th:field="*{policyholder.birthDate}" class="datepicker" placeholder="DD.MM.YYYY">
                </div>

                <div class="form-group">
                    <label for="policyholder.mobileNumber">رقم الهاتف المحمول</label>
                    <input type="tel" id="policyholder.mobileNumber" th:field="*{policyholder.mobileNumber}">
                </div>

                <div class="form-group">
                    <label for="policyholder.phoneNumber">رقم الهاتف</label>
                    <input type="tel" id="policyholder.phoneNumber" th:field="*{policyholder.phoneNumber}">
                </div>

                <div class="form-group">
                    <label for="policyholder.emailAddress">البريد الإلكتروني</label>
                    <input type="email" id="policyholder.emailAddress" th:field="*{policyholder.emailAddress}">
                </div>
            </div>

            <div class="buttons">
                <button type="button" class="prev-button" data-step="3">السابق</button>
                <button type="button" class="next-button" data-step="3">التالي</button>
            </div>
        </div>

        <!-- Step 4: Signature and Submit -->
        <div id="step-4" class="step-content">
            <div class="section">
                <h2>التوقيع</h2>
                <p>الرجاء التوقيع هنا:</p>
                <div class="signature-container">
                    <canvas id="signature-pad"></canvas>
                </div>
                <div>
                    <button type="button" id="reset-button">مسح التوقيع</button>
                </div>
            </div>
            <div class="buttons">
                <button type="button" class="prev-button" data-step="4">السابق</button>
                <button type="submit">إرسال الاستمارة</button>
                <button type="button" id="reset-form-button">إعادة تعيين الاستمارة</button>
            </div>
        </div>
    </form>
</div>

<script>
    let signaturePad;
    let currentStep = 1;

    document.addEventListener("DOMContentLoaded", function() {
        // Initialize datepicker
        $(".datepicker").datepicker({
            dateFormat: 'dd.mm.yy',
            changeMonth: true,
            changeYear: true,
            yearRange: "-100:+0"
        });

        // Age calculation and guardian section visibility
        function calculateAge(birthDateString) {
            if (!birthDateString) return null;

            // Parse date format (dd.mm.yyyy)
            const parts = birthDateString.split('.');
            if (parts.length !== 3) return null;

            const birthDate = new Date(parts[2], parts[1] - 1, parts[0]);
            const today = new Date();
            let age = today.getFullYear() - birthDate.getFullYear();
            const monthDiff = today.getMonth() - birthDate.getMonth();

            if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthDate.getDate())) {
                age--;
            }

            return age;
        }

        function updateGuardianSection() {
            const birthDateInput = document.getElementById('birthDate');
            const guardianSection = document.getElementById('guardian-section');
            const policyholderSection = document.getElementById('policyholder-section');
            const insuranceTypeField = document.getElementById('insuranceType');
            const minorInsuranceInfo = document.getElementById('minor-insurance-info');
            const guardianFields = document.querySelectorAll('.guardian-required');
            const policyholderFields = document.querySelectorAll('.policyholder-required');

            const age = calculateAge(birthDateInput.value);

            if (age !== null && age < 18) {
                // Patient is a minor - show both guardian and policyholder sections
                guardianSection.classList.add('visible');
                policyholderSection.classList.add('visible');
                minorInsuranceInfo.style.display = 'block';

                // Set insurance type to FAMILY_INSURED for minors
                insuranceTypeField.value = 'FAMILY_INSURED';

                // Make fields required
                guardianFields.forEach(field => {
                    field.setAttribute('required', 'required');
                });
                policyholderFields.forEach(field => {
                    field.setAttribute('required', 'required');
                });
                console.log('Patient is minor (age: ' + age + ') - guardian and policyholder sections shown');
            } else {
                // Patient is adult - hide sections and clear
                guardianSection.classList.remove('visible');
                policyholderSection.classList.remove('visible');
                minorInsuranceInfo.style.display = 'none';

                // Set insurance type to SELF_INSURED for adults
                insuranceTypeField.value = 'SELF_INSURED';

                // Remove required and clear fields
                guardianFields.forEach(field => {
                    field.removeAttribute('required');
                    field.value = '';
                });
                policyholderFields.forEach(field => {
                    field.removeAttribute('required');
                    field.value = '';
                });
                document.getElementById('sameAsGuardian').checked = false;
                console.log('Patient is adult (age: ' + age + ') - sections hidden');
            }
        }

        // "Same as guardian" checkbox handler
        document.getElementById('sameAsGuardian').addEventListener('change', function() {
            if (this.checked) {
                // Copy guardian data to policyholder fields
                document.getElementById('policyholder.firstName').value =
                    document.getElementById('guardian.firstName').value;
                document.getElementById('policyholder.lastName').value =
                    document.getElementById('guardian.lastName').value;
                document.getElementById('policyholder.birthDate').value =
                    document.getElementById('guardian.birthDate').value;
                document.getElementById('policyholder.mobileNumber').value =
                    document.getElementById('guardian.mobileNumber').value;
                document.getElementById('policyholder.phoneNumber').value =
                    document.getElementById('guardian.phoneNumber').value;
                document.getElementById('policyholder.emailAddress').value =
                    document.getElementById('guardian.emailAddress').value;

                console.log('Policyholder data copied from guardian');
            }
        });

        // Listen for birthdate changes
        $('#birthDate').on('change', updateGuardianSection);

        // Check on page load (in case form has pre-filled data)
        updateGuardianSection();

        // Initialize signature pad (only when step 4 is visible)
        function initSignaturePad() {
            if (!signaturePad) {
                const canvas = document.getElementById("signature-pad");
                signaturePad = new SignaturePad(canvas, {
                    minWidth: 1,
                    maxWidth: 2.5, // Reduced max width for signature line
                    backgroundColor: 'rgb(255, 255, 255)',
                    penColor: 'rgb(0, 0, 0)'
                });

                // Resize canvas to fill its container
                resizeCanvas();
            }
        }

        function resizeCanvas() {
            const canvas = document.getElementById("signature-pad");
            const ratio = Math.max(window.devicePixelRatio || 1, 1);
            canvas.width = canvas.offsetWidth * ratio;
            canvas.height = canvas.offsetHeight * ratio;
            canvas.getContext("2d").scale(ratio, ratio);
            if (signaturePad) {
                signaturePad.clear(); // otherwise isEmpty() might return incorrect value
            }
        }

        window.addEventListener("resize", function() {
            if (currentStep === 4) resizeCanvas();
        });

        // Handle navigation between steps
        document.querySelectorAll('.next-button').forEach(button => {
            button.addEventListener('click', function() {
                const step = parseInt(this.getAttribute('data-step'));

                // Validation for step 1
                if (step === 1) {
                    const firstName = document.getElementById('firstName').value;
                    const lastName = document.getElementById('lastName').value;
                    const birthDate = document.getElementById('birthDate').value;
                    const gender = document.getElementById('gender').value;

                    if (!firstName || !lastName || !birthDate || !gender) {
                        alert('الرجاء ملء جميع الحقول المطلوبة.');
                        return;
                    }
                }

                // Validation for step 3 (including guardian and policyholder if minor)
                if (step === 3) {
                    const guardianSection = document.getElementById('guardian-section');
                    const policyholderSection = document.getElementById('policyholder-section');

                    if (guardianSection.classList.contains('visible')) {
                        // Validate guardian fields
                        const guardianRelationship = document.getElementById('guardian.relationshipType').value;
                        const guardianFirstName = document.getElementById('guardian.firstName').value;
                        const guardianLastName = document.getElementById('guardian.lastName').value;
                        const guardianMobile = document.getElementById('guardian.mobileNumber').value;

                        if (!guardianRelationship || !guardianFirstName || !guardianLastName || !guardianMobile) {
                            alert('الرجاء ملء جميع الحقول المطلوبة للوصي القانوني (المشار إليها بعلامة *).');
                            return;
                        }

                        // Validate policyholder fields
                        const policyholderFirstName = document.getElementById('policyholder.firstName').value;
                        const policyholderLastName = document.getElementById('policyholder.lastName').value;

                        if (!policyholderFirstName || !policyholderLastName) {
                            alert('الرجاء ملء جميع الحقول المطلوبة لحامل البوليصة الأساسي (المشار إليها بعلامة *).');
                            return;
                        }
                    }
                }

                // Hide current step
                document.getElementById(`step-${step}`).classList.remove('active');

                // Show next step
                const nextStep = step + 1;
                document.getElementById(`step-${nextStep}`).classList.add('active');

                // Update step indicator
                document.querySelector(`.step[data-step="${step}"]`).classList.add('completed');
                document.querySelector(`.step[data-step="${nextStep}"]`).classList.add('active');

                // Update current step
                currentStep = nextStep;

                // Initialize signature pad on step 4
                if (nextStep === 4) {
                    initSignaturePad();
                }
            });
        });

        document.querySelectorAll('.prev-button').forEach(button => {
            button.addEventListener('click', function() {
                const step = parseInt(this.getAttribute('data-step'));

                // Hide current step
                document.getElementById(`step-${step}`).classList.remove('active');

                // Show previous step
                const prevStep = step - 1;
                document.getElementById(`step-${prevStep}`).classList.add('active');

                // Update step indicators - fix for back button
                document.querySelector(`.step[data-step="${step}"]`).classList.remove('active');
                document.querySelector(`.step[data-step="${step}"]`).classList.remove('completed');
                document.querySelector(`.step[data-step="${prevStep}"]`).classList.add('active');

                // Update current step
                currentStep = prevStep;
            });
        });

        // Reset signature button
        document.getElementById("reset-button").addEventListener("click", function() {
            if (signaturePad) signaturePad.clear();
        });

        // Reset entire form button
        document.getElementById("reset-form-button").addEventListener("click", function() {
            // Reset all form fields
            document.getElementById("patient-form").reset();

            // Clear signature pad
            if (signaturePad) signaturePad.clear();

            // Go back to step 1
            document.querySelectorAll('.step-content').forEach(step => {
                step.classList.remove('active');
            });
            document.getElementById('step-1').classList.add('active');

            // Reset step indicators
            document.querySelectorAll('.step').forEach(indicator => {
                indicator.classList.remove('active');
                indicator.classList.remove('completed');
            });
            document.querySelector('.step[data-step="1"]').classList.add('active');

            // Update current step
            currentStep = 1;

            console.log("Form has been reset");
        });

        // Form submission
        document.getElementById("patient-form").addEventListener("submit", function(event) {
            // Validate required fields on the current page
            if (currentStep === 1) {
                const firstName = document.getElementById('firstName').value;
                const lastName = document.getElementById('lastName').value;
                const birthDate = document.getElementById('birthDate').value;
                const gender = document.getElementById('gender').value;

                if (!firstName || !lastName || !birthDate || !gender) {
                    event.preventDefault();
                    alert('الرجاء ملء جميع الحقول المطلوبة.');
                    return;
                }
            }

            // Add signature data if available
            if (signaturePad && !signaturePad.isEmpty()) {
                console.log("Signature captured, adding to form...");

                // Get signature data - using lower quality to reduce size
                const signatureData = signaturePad.toDataURL('image/png', 1);

                // Log the first 20 characters (for debugging)
                console.log("Signature data (first 20 chars): " + signatureData.substring(0, 20) + "...");

                // Create hidden input for signature data
                let signatureInput = document.createElement("input");
                signatureInput.type = "hidden";
                signatureInput.name = "signatureData";
                signatureInput.value = signatureData;

                // Add to form
                this.appendChild(signatureInput);
            } else {
                console.log("No signature provided");
            }

            console.log("Form submitted");
        });
    });
</script>
</body>
</html>
